<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="js/functions.js"></script>
    <!--fonts-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Allerta+Stencil">
    <title>Login</title>
  </head>
  <body>
    <div id="startScreen" class="w3-container">

      <div class="w3-container w3-center nomeExDiv">
        <h1 id="exName" class="w3-allerta w3-text-white nomeEx">exercise Name</h1>
        <span id="congrat" class="w3-allerta letterSerie w3-text-orange">Serie: <span id="numS">2</span></span>
      </div>

      <div class="w3-container w3-center timer">
        <span id="count" class="countdown w3-allerta w3-text-white" >GO</span>
      </div>

      <div class="w3-container w3-center w3-allerta lastInfo w3-text-light-gray">
        <table id="tableBf">
          <!--<tr class="w3-black">
<th colspan="3">28/07</th>
</tr>
<tr class="w3-orange">
<td>Serie</td>
<td>Weight</td>
<td>Reps</td>
</tr>
<tr>
<td>1</td>
<td>15kg</td>
<td>10</td>
</tr>
<tr>
<td>2</td>
<td>15kg</td>
<td>10</td>
</tr>
<tr>
<td>3</td>
<td>15kg</td>
<td>10</td>
</tr>
<tr>
<td>4</td>
<td>15kg</td>
<td>10</td>
</tr>-->
        </table>

        <table id="tableToday" class="">


        </table>
      </div>

      <div class="w3-container  w3-center w3-margin">
        <button id="btnDone" class="w3-button w3-orange w3-round-large textFontSize w3-allerta" onclick="doneSer()">Done !</button>

        <button id="btnSaveR" class="w3-hide w3-button w3-green w3-round-large  w3-allerta" onclick="finish()">Finish</button>
      </div>


      <div id="modalDone" class="w3-modal">
        <div class="w3-modal-content w3-card-4">
          <header class="w3-container w3-center w3-black w3-padding">
            <span onclick="document.getElementById('modalDone').style.display='none'"
                  class="w3-button w3-display-topright fontTitleSmall iconX w3-hover-white">&times;</span>
            <a class="fontTitleSmall w3-allerta ">Informations</a>
          </header>
          <div class="w3-container w3-padding w3-center ">

            <label class="w3-text-black labelEdit">How many repetitions you did?</label><br>
            <div class="w3-container w3-round-large w3-orange chooseNumberDiv">
              <div id="minusRep" class="w3-container signSize " onclick="minusReps()">&ndash;
              </div>
              <div class="w3-container inputSize ">
                <input id="valueRep" value="0" />
              </div>
              <div id="plusRep" class="w3-container signSize "  onclick="plusReps()">+
              </div>
            </div>


            <br><label class="w3-text-black labelEdit">How much weight (if changed)</label><br>
            <div class="w3-container w3-round-large w3-orange chooseNumberDiv">
              <div id="minusWeight" class="w3-container signSize " onclick="minusWeights()">&ndash;
              </div>
              <div class="w3-container inputSize ">
                <input id="valueWeight" value="0" />
              </div>
              <div id="plusWeight" class="w3-container signSize "  onclick="plusWeights()">+
              </div>
            </div>

          </div>
          <div class="w3-container w3-center w3-padding w3-theme w3-light-gray">
            <div class="w3-container w3-button confirmEdit w3-border w3-round-large w3-black w3-hover-white " onclick="saveResults()">Confirm &emsp;<i class="fa fa-check"></i></div>
          </div>
        </div>
      </div>
    </div>

    <script>

      var ex = JSON.parse(localStorage.exs);
      var elem = document.getElementById('count');
      var numS = document.getElementById('numS');
      var timerID;
      var serieNumber = 0;
      var workoutNumber = 0;
      var timeLeft = ex.exercises[0].rest;
      var maxExerc = ex.exercises.length;
      var exName = ex.exercises[0].name;
      var exAntName = exName;
      var exID = ex.exercises[0].ID;
      var exAntID = exID;
      var maxSeries = ex.exercises[0].reps;
      var serAnt = 0;
      var exResults = {
        "series" : []
      };

      $( "#exName" ).ready(function() {
        $("#exName").text(exName);
        $("#numS").text(serieNumber+1);
      });

      $( "#tableToday" ).ready(function() {
        createTableToday();
      });

      $( "#tableBf" ).ready(function() {
        createTableBefore();
      });

      function createTableToday(){
        var append = '	<tr class="w3-black">'
        +'          <th colspan="3">Today</th>'
        +'        </tr>'
        +'        <tr class="w3-orange">'
        +'          <td>Serie</td>  '
        +'          <td>Weight</td> '
        +'          <td>Reps</td>'
        +'        </tr>';
        for(var i = 0 ; i < maxSeries ; i++){
          append += '<tr>';
          append += '<td>'+ (i+1) +'</td>';
          append += '<td id="Wtoday' + i +'"> </td>';
          append += '<td id="Rtoday' + i +'"> </td>';
          append += '</tr>';
        }
        $("#tableToday").html(append);
      }

      function setTable(){
        $("#Wtoday" + serAnt).text($(valueWeight).val());
        $("#Rtoday" + serAnt).text($(valueRep).val());
      }

      function createTableBefore(){
        if(localStorage.lastResults === undefined){
          $("#tableToday").removeClass("doubleTable");
          $("#tableToday").addClass("singleTable");
          //alert("single table");
        }
        else{
          $("#tableToday").removeClass("singleTable");
          $("#tableToday").addClass("doubleTable");
          alert(localStorage.lastResults);
          var series = JSON.parse(localStorage.lastResults).series;
          //alert(JSON.stringify(series));

          var counter = 0;

          while(series[counter].exID != exID && counter < 1000){
            counter++;
          }

          //alert("position = " + counter);

          var lastData = series;

          var append = '	<tr class="w3-black">'
          +'          <th colspan="3">'+ lastData[0].dateDone +'</th>'
          +'        </tr>'
          +'        <tr class="w3-orange">'
          +'          <td>Serie</td>  '
          +'          <td>Weight</td> '
          +'          <td>Reps</td>'
          +'        </tr>';

          var max = parseInt(maxSeries) + parseInt(counter);
          //alert("maxseries= " + maxSeries + "counter= " + counter);
          for(var i = counter, j = 0 ; i < max ; i++, j++){
            append += '<tr>';
            append += '<td>'+ (j+1) +'</td>';
            append += '<td id="Wbf' + j +'">' + series[i].weight +' </td>';
            append += '<td id="Rbf' + j +'">' + series[i].reps +' </td>';
            append += '</tr>';
          }
          $("#tableBf").html(append);
        }
      }

      function doneSer(){
        document.getElementById('modalDone').style.display='block';
        $("#btnDone").addClass("w3-hide");

        if(serieNumber == maxSeries - 1){
          if(workoutNumber == maxExerc -1){
            $("#exName").text("Finished");
            elem.innerHTML = ';D';
            $("#btnDone").addClass("w3-hide");
            $("#btnSaveR").removeClass("w3-hide");
            $("#congrat").text("Congratulations");
            $("#numS").text(" ");
            serAnt = serieNumber;
            exAntName = ex.exercises[workoutNumber].name;
            exAntID =  ex.exercises[workoutNumber].ID;
          }else{
            exAntName = exName;
            exAntID = exID;
            workoutNumber++;
            serAnt = serieNumber;
            serieNumber = 0;
            //alert("a");
            maxSeries = ex.exercises[workoutNumber].reps;
            //alert("att name");
            exName = ex.exercises[workoutNumber].name;
            exID =  ex.exercises[workoutNumber].ID;
            timerID = setInterval(countdown, 1000);
            $("#exName").text(ex.exercises[workoutNumber].name);
            $("#numS").text(serieNumber+1);
            createTableToday();
            createTableBefore();
          }
        }else{
          //alert("att serie");
          exAntName = exName;
          exAntID = exID;
          serieNumber++;
          serAnt = serieNumber - 1;
          $("#numS").text(serieNumber+1);
          timerID = setInterval(countdown, 1000);
        }
      }

      function countdown() {
        if (timeLeft == 0) {
          clearTimeout(timerID);
          timeLeft = ex.exercises[workoutNumber].rest;
          elem.innerHTML = 'GO';
          $("#btnDone").removeClass("w3-hide");
        } else {
          elem.innerHTML = timeLeft;
          timeLeft--;
        }
      }

      function saveResults(){
        var serie = {
          "exercise" : exAntID,
          "serieNumber" : serAnt,
          "reps" : $(valueRep).val(),
          "weight": $(valueWeight).val(),
          "wkID" : localStorage.selectedWkID
        }
        //alert("pushing");
        exResults.series.push(serie);
        //alert("pushed");
        //alert(JSON.stringify(exResults));
        document.getElementById('modalDone').style.display='none'
        if(serAnt < serieNumber || (maxExerc-1 == workoutNumber && serieNumber == maxSeries)){
          setTable();
          //alert(serAnt+1);
          //alert(maxSeries);
        }
      }

      function finish(){
        //alert("congrats");
        localStorage.finalWkResults = JSON.stringify(exResults);
        finishWorkout();
      }



    </script>

  </body>
</html>
